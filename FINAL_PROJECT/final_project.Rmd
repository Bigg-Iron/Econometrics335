---
title: "Final Project"
author: "Lorenzo Bartolo"

output:
  pdf_document: default
  html_document: default
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE, echo = TRUE)

# List of packages you want to install -- separated with a comma and surrounded in "quotes" 
packages <- c("tidyverse", "dplyr", "moments", "lmtest", "sandwich", "stringr", "readr", "here", "ggplot2", "modelr", "MASS", "knitr", "formatR", "car", "AER", "plm", "stargazer", "readxl", "haven", "fastDummies")

# Installs packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Loads packages
invisible(lapply(packages, library, character.only = TRUE))

# Load in Data
data_table_16 <- read_csv(here("./Data/health_ineq_online_table_16.csv"))

setwd(here("final_project"))

```


# 1. Introduction and Statement of Research Question
- Pose and motivate the question to be investigated with your data and econometric model.
The relationship between income and health outcomes are well established. However, I wanted to investigate the relationship between an individual's income and their life expectancy. To put simply, does income effect how long you live?


- Express the question both verbally and in the form of an equation to be estimated. Be sure to include the names and units of the dependent and independent variables.
- You must include at least three independent variables, but can include as many as you’d like
beyond that.
- Explain the mechanisms you believe pertain to your study question and why you selected the
particular X variables that you did and why you didn’t select others.
- You may also want to briefly cite relevant literature (e.g. previous studies) that you come across while researching your topic.

    I hypothesize that individual income has a significant effect on mortality and life expectancy. The United State's lack of basic social programs, and the privatization of healthcare, simply equates to health outcomes in proportion to an individual's income. Under the classical assumptions of economics, the market for healthcare services would behave identically to any other market, i.e. the market for an automobile; the vehicles with better features, airbags, seatbelts, cupholders, etc., will inherently cost more, and only the individual's who can afford these features will purchase the automobile. This often implies that those with higher incomes can afford vehicles with more advanced safety systems, reducing their chances of being injured or dying in a car crash. I hypothesize that these same market mechanisms apply to healthcare, and are pronounced due to the nature of services being sought. Individual's at the lower end of the income distribution are not able to afford the same healthcare services that the top income earners can afford. It is well established that access to better healthcare improves individual health outcomes and life expectancy. Therefore, it is reasonable to assume that those who do not have access to quality healthcare will have poorer health outcomes and a shorter life expectancy. 
    
    I test the hypothesis that individual income is a statistically significant indicator on life expectancy and mortality rate. In the model I have included individual income (indv_inc), individual income percentile (indv_pctile), while holding gender (gnd) constant.
    
    
## Mortality Rate Model Specifications:
$$ \widehat{MortalityRate_{it}} =  \beta_0 + \beta_1 + u_{it} $$
```{r}
Mortality.model.1 <- lm(data_table_16$mortrate ~ data_table_16$indv_inc)
summary(Mortality.model.1)
coeftest(Mortality.model.1, vcov. = vcovHC, type = "HC1")


Mortality.model.2 <- lm(data_table_16$mortrate ~ data_table_16$indv_inc + data_table_16$indv_pctile)
summary(Mortality.model.2)
coeftest(Mortality.model.2, vcov. = vcovHC, type = "HC1")


Mortality.model.3 <- lm(data_table_16$mortrate ~ data_table_16$indv_inc + data_table_16$indv_pctile + data_table_16$age_at_d)
summary(Mortality.model.3)
coeftest(Mortality.model.3, vcov. = vcovHC, type = "HC1")

```


## Life Expectancy Model Specifications:
$$ \widehat{LifeExpectancy_{it}} =  \beta_0 + \beta_1 + u_{it} $$
```{r}

Life.Expect.model.1 <- lm(data_table_16$age_at_d ~ data_table_16$indv_inc)
summary(Life.Expect.model.1)
coeftest(Mortality.model.1, vcov. = vcovHC, type = "HC1")

Life.Expect.model.2 <- lm(data_table_16$age_at_d ~ data_table_16$indv_inc + data_table_16$indv_pctile)
summary(Life.Expect.model.2)
coeftest(Mortality.model.2, vcov. = vcovHC, type = "HC1")

Life.Expect.model.3 <- lm(data_table_16$age_at_d ~ data_table_16$indv_inc + data_table_16$indv_pctile + data_table_16$mortrate)
summary(Life.Expect.model.3)
coeftest(Mortality.model.3, vcov. = vcovHC, type = "HC1")

```





# 2. Data Description
- Describe the data used to estimate the model. Your data set must have at least 40 observations.
- You should construct a table that provides the mean, minimum, maximum and standard deviation (and any other summary statistics you feel are relevant) of all variables in the model.
- You might also want to show and discuss key scatterplots or graphs of interest.

    The data used was deidentified data from federal income tax records from 1999 to 2014. The measure of income was pretax earnings. Mortality and death rates were attained from the Social Security Administration (SSA). There are several limitations to the data: while I would have liked to include more variables in the regression models, such as race or ethnicity, but race and ethnicity are not recorded in tax records. The other limitation within the data is that the data is not made available to the public, so I had to derive the data from a 2016 JAMA study: "The Association Between Income and Life Expectancy in the United States, 2001-2014".

    This table reports US mortality rates by gender, age, year and individual income percentile. Individual income percentiles are calculated separately for each gender, age, and year. Incomes are measured two years prior to the mortality rate for mortality rates at ages 40-63, and at age 61 for mortality rates at ages 64-76. The “lag” variable indicates the number of years between measurement of income and mortality. Observations with 1 or 2 deaths have been masked: all mortality rates that reflect only 1 or 2 deaths have been recoded to reflect 3 deaths. Additionally, I added two columns to the dataset with binary "dummy" variables (0 if Male, and 1 if Female) to perform regression on gender.


    Variable Name:                         Variable Description:
    
    gnd                                     Gender
    *gnd_M                                  Male Gender
    *gnd_F                                  Female Gender
    indv_pctile                             Individual Income Percentile
    age_at_d                                Age at Death
    yod                                     Year of Death
    lag                                     Income Lag
    mortrate                                Mortality Rate
    indv_inc                                Mean Individual Income
    deaths                                  Numerator of mortrate
    count                                   Denominator of mortrate (alive at beginning of year)


*NOTE: [INSERT SUMMARY STATISTICS HERE]*
```{r, results='asis'}

stargazer(as.data.frame(data_table_16),
          header = FALSE,
          type = "latex",
          title = "National mortality rates by gender, age, year, and individual income percentile")

stargazer(data_table_16[0:9,],
          header = FALSE,
          summary = FALSE,
          rownames = FALSE,
          align = TRUE,
          type = "latex")

```




# 3. Formulation of the Model
- Express the question both verbally and in the form of an equation to be estimated. Be sure to include the names and units of the dependent and independent variables.
- You must include at least three independent variables, but can include as many as you’d like
beyond that.
- Explain the mechanisms you believe pertain to your study question and why you selected the
particular X variables that you did and why you didn’t select others.
- You may also want to briefly cite relevant literature (e.g. previous studies) that you come across while researching your topic.

    I hypothesize that individual income has a significant effect on mortality and life expectancy. The United State's lack of basic social programs, and the privatization of healthcare, simply equates to health outcomes in proportion to an individual's income. Under the classical assumptions of economics, the market for healthcare services would behave identically to any other market, i.e. the market for an automobile; the vehicles with better features, airbags, seatbelts, cupholders, etc., will inherently cost more, and only the individual's who can afford these features will purchase the automobile. This often implies that those with higher incomes can afford vehicles with more advanced safety systems, reducing their chances of being injured or dying in a car crash. I hypothesize that these same market mechanisms apply to healthcare, and are pronounced due to the nature of services being sought. Individual's at the lower end of the income distribution are not able to afford the same healthcare services that the top income earners can afford. It is well established that access to better healthcare improves individual health outcomes and life expectancy. Therefore, it is reasonable to assume that those who do not have access to quality healthcare will have poorer health outcomes and a shorter life expectancy. 
    
    I test the hypothesis that individual income is a statistically significant indicator on life expectancy and mortality rate. In the model I have included individual income (indv_inc), individual income percentile (indv_pctile), while holding gender (gnd) constant.
    
    
## Mortality Rate Model Specifications:
$$ \widehat{MortalityRate_{it}} =  \beta_0 + \beta_1 + u_{it} $$
```{r}
Mortality.model.1 <- lm(data_table_16$mortrate ~ data_table_16$indv_inc)
summary(Mortality.model.1)
coeftest(Mortality.model.1, vcov. = vcovHC, type = "HC1")


Mortality.model.2 <- lm(data_table_16$mortrate ~ data_table_16$indv_inc + data_table_16$indv_pctile)
summary(Mortality.model.2)
coeftest(Mortality.model.2, vcov. = vcovHC, type = "HC1")


Mortality.model.3 <- lm(data_table_16$mortrate ~ data_table_16$indv_inc + data_table_16$indv_pctile + data_table_16$age_at_d + data_table_16$gnd_M)
summary(Mortality.model.3)
coeftest(Mortality.model.3, vcov. = vcovHC, type = "HC1")

```


## Life Expectancy Model Specifications:
$$ \widehat{LifeExpectancy_{it}} =  \beta_0 + \beta_1 + u_{it} $$
```{r}

Life.Expect.model.1 <- lm(data_table_16$age_at_d ~ data_table_16$indv_inc)
summary(Life.Expect.model.1)
coeftest(Mortality.model.1, vcov. = vcovHC, type = "HC1")

Life.Expect.model.2 <- lm(data_table_16$age_at_d ~ data_table_16$indv_inc + data_table_16$indv_pctile)
summary(Life.Expect.model.2)
coeftest(Mortality.model.2, vcov. = vcovHC, type = "HC1")

Life.Expect.model.3 <- lm(data_table_16$age_at_d ~ data_table_16$indv_inc + data_table_16$indv_pctile + data_table_16$gnd_F + data_table_16$mortrate)
summary(Life.Expect.model.3)
coeftest(Mortality.model.3, vcov. = vcovHC, type = "HC1")

```





# 4. Empirical Results
- You may want to, for example, examine your key parameter estimates with and without additional regressors to compare any differences (i.e., run a single regressor model and then a multiple regression model).
- You should show at least three specifications of your design.
- These will likely include various non-linear versions of a baseline model, for example by adding a polynomial or interaction variable, or by creating relevant categorical or binary variables to analyze group effects.
- Explain the meaning of estimated coefficients in your model and whether or not coefficients are statistically significant and at what level.
- Also discuss the goodness of fit measure for the model (e.g. R-squared, SER, adjusted R-squared). 

## Empirical Results of Mortality Rate Models

    The first mortality model (Mortality.model.1), the coefficient representing individual income (indv_inc) was regressed on mortality rates. The average mortality rate for this model was:   6.362e-03. According to the model summary, there is an inverse relationship between income and the mortality rate: on average, as an individual's income rises by $1.00 USD, the individual's mortality rate decreases by -6.7516e-09. The t-value for the individual income coefficient was -32.35. If we used an alpha level of α = .05 to determine which predictors were significant in this regression model, we would say that indv_inc is a statistically significant predictor of the mortality rate in this sample. The R-squared for this model was 0.01934, which represents the proportion of the variance for the mortality rate that can be explained by the coefficients. The standard error of the regression line (SER) was 0.006259, which represents the average distance that the observed values of mortality rate fall from the actual values on the regression line. All the coefficients in the models I tested were statistically significant at predicting mortality rates at the level of α = .05; Most notably, individual income percentile (indv_pctile) was statistically the most significant indicator of mortality rate (besides age_at_d, which is to be expected) out of all the coefficients, with a t-value of -182.718, which was significant at the level of α = .001. These results are summarized in Table 1.


## Empirical Results of Life Expectancy Models:

    The second model specification was regressing different coefficients on life expectancy. The average age at death (age_at_d) for this model was: 39.97.
    If we used an alpha level of α = .05 to determine which coefficients were significant at predicting life expectancy or age at death, this regression model, we would say that all of the coefficients were statistically significant predictors of life expectancy in this sample. Behind mortality rate, which is to be expected, the most statistically significant coefficient for this regression model was also individual income percentile (indv_pctile). With a t-value of 140.24, it was significant at predicting the life expectancy of individuals at levels down to α = .001. 
    The R-squared for this life expectancy model was 0.6748, which represents the proportion of the variance for life expectancy that can be explained by the coefficients in the model. The standard error of the regression line (SER) was 5.273, which represents the average distance that the observed values of life expectancy fell from the actual values on the regression line. These results are summarized in Table 2.


*NOTE: [INSERT STARGAZER TABLE RESULTS]*
```{r, results='asis'}

# Mortality Models STARGAZER TABLE
stargazer(Mortality.model.1, Mortality.model.2, Mortality.model.3,
          digits = 3,
          header = FALSE,
          type = "latex", 
          title = "Table 1: Mortality Models",
          model.numbers = TRUE,
          out="mortality_table.txt")

# Life Expectancy Models STARGAZER TABLE
stargazer(Life.Expect.model.1, Life.Expect.model.2, Life.Expect.model.3,
          digits = 3,
          header = FALSE,
          type = "latex", 
          title = "Table 2: Life Expectancy Models",
          model.numbers = TRUE,
          summary = TRUE,
          t.auto = TRUE,
          out="life_expect_table.txt")

```


# 5. Summary and Discussion
- Summarize your main results and discuss limitations to your approach.
- Suggest what other independent variables, possible functional forms, or statistical tests might be appropriate to include and any interesting follow-up questions or extensions that may have come to mind.
- Carefully explain caveats to your study, especially whether or not certain parameter estimates may be biased.
- Address all issues of internal and external validity.
    While the results of the regression models were significant, they are not completely surprising. I previously hypothesized that income would be a strong determining factor on health outcomes in the United States, for the reason that healthcare services are bought and sold on a marketplace, and the healthcare services of higher quality will often cost more than those of lesser quality. Consequently, those who have the ability to purchase higher quality healthcare services would realize the benefits as longer life expectancies and lower mortality rates. It is also important to realize that at some income levels, certain healthcare procedures that are not covered by individual's health insurance, would simply be unattainable. To use an exaggerated example, a patient seeking an additional round of chemotherapy treatment for cancer, might not be able to cover the cost of the procedure if it was not covered under their health insurance. Thus, forgoing the additional round of chemotherapy that could have hypothetically extended their life. 
    
    One unfortunate limitation of this study, was not being able to accurately control for race or ethnicity. As discussed previously, this information is not recorded on collected tax data, and I would hypothesize that it would also be a significant indicator for life expectancy and mortality rates. Given more time, I would have also liked to compare the results of these models to similar studies done internationally, to contrast the differing results. Additionally, I would like to see how recent COVID-19 data would effect the results of the models.


# 6. Graphs and Figures

## Income and Mortality Rate
```{r}
# Plot Income and Mortality Rate
plot(x = data_table_16$indv_inc, 
     y = data_table_16$mortrate, 
     xlab = "Income",
     ylab = "Mortality Rate",
     main = "Mortality Rates and Income",
     col = "steelblue")
# Add trend line
abline(Mortality.model.1, col = "red")
```

## Income and Life Expectancy
```{r}
# Plot Income and Life Expectancy
plot(x = data_table_16$indv_inc, 
     y = data_table_16$age_at_d, 
     xlab = "Income",
     ylab = "Age at Death",
     main = "Life Expectancy and Income",
     col = "steelblue")
# Add trend line
abline(Life.Expect.model.1, col = "red")
```


# 7. Bibliography
All cited sources should be reported in a bibliography in MLA format.
o One useful reference is your textbook.
Also include anything relevant that is not within the main document at the end, such as
attachments of key R output (Here I want regression or summary statistics outputs, and not a
series of lines of code)
Sources Used:
- Econometrics with R: https://www.econometrics-with-r.org/10-rwpd.html
- Investopedia: https://www.investopedia.com/terms/r/residual-standard-deviation.asp
- Website: https://www.statology.org/significance-codes-in-r/
- Website: https://www.marsja.se/create-dummy-variables-in-r/
- 2016 JAMA Study: https://jamanetwork.com/journals/jama/fullarticle/2513561?guestAccessKey=4023ce75-d0fb-44de-bb6c-8a10a30a6173
- Introduction to Econometrics Book


